{% extends 'base.html' %}

{% load static %}

{% block content %}

<div class="create-post">
    <h2>Create a new post</h2>
    <form method="post" action="{% url 'webapp:home' %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.media }} 
        {{ form.as_p }}
        <input type="hidden" name="latitude" id="latitude" value="{{ form.initial.latitude }}">
        <input type="hidden" name="longitude" id="longitude" value="{{ form.initial.longitude }}">
        <input type="hidden" name="place_name" id="place_name" value="{{ form.initial.place_name }}">
        <input type="hidden" name="place_id" id="place_id" value="{{ form.initial.place_id }}">
        <div id="map" style="height: 400px; width: 100%;"></div>   
        <button type="submit">Publish Your Post</button>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>

var map;
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: -34.397, lng: 150.644},
        zoom: 8
    });

    const input = document.getElementById('location');
    const latitude = document.getElementById('latitude');
    const longitude = document.getElementById('longitude');
    const autocomplete = new google.maps.places.Autocomplete(input);

    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }

        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(16);
        }

        latitude.value = place.geometry.location.lat();
        longitude.value = place.geometry.location.lng();
        document.getElementById('place_name').value = place.name;
        document.getElementById('place_id').value = place.place_id;

        marker.setPosition(place.geometry.location);
        marker.setVisible(true);
    });
}

function loadGoogleMapsScript(apiKey) {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
}

// Fetch the API key from the Django view and load the Google Maps API script
fetch("{% url 'webapp:get_api_key' %}")
    .then(response => response.json())
    .then(data => {
        loadGoogleMapsScript(data.google_api_key);
    })
    .catch(error => {
        console.error('Error fetching API key:', error);
    });
</script>
{% endblock %}